<div class="cbi-section">
	<h3>æ“ä½œ</h3>
	<div class="cbi-section-node">
		<input type="button" class="cbi-button cbi-button-apply" value="æµ‹è¯•è¿æ¥" onclick="testProxy()" />
		<span id="test-result" style="margin-left: 10px; font-weight: bold;"></span>
		<br/><br/>
		<input type="button" class="cbi-button cbi-button-save" value="å¼€å§‹å‡çº§" onclick="startUpgrade()" />
	</div>
	
	<h3>å‡çº§æ—¥å¿—</h3>
	<textarea id="upgrade-log" style="width: 100%; height: 300px; font-family: monospace; margin-top: 10px;" readonly></textarea>
</div>

<div class="cbi-section">
    <h3>æ’ä»¶è¯´æ˜ä¸æ•™ç¨‹</h3>
    <div class="cbi-section-node">
        <div class="cbi-value">
            <div class="cbi-value-field" style="width: 100%; color: #666; line-height: 1.8; font-size: 14px;">
                
                <div style="background-color: #e8f5e9; padding: 15px; border-left: 5px solid #4caf50; margin-bottom: 20px; border-radius: 4px;">
                    <h4 style="margin-top: 0; color: #2e7d32;">ğŸ’¡ è¿™ä¸ªæ’ä»¶æ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</h4>
                    <p>ç®€å•æ¥è¯´ï¼Œå®ƒèƒ½<strong>è®© OpenWrt "å€Ÿç”¨" æ‚¨ç”µè„‘çš„æ¢¯å­æ¥ä¸‹è½½è½¯ä»¶</strong>ã€‚</p>
                    <p><strong>åœºæ™¯ä¸¾ä¾‹ï¼š</strong></p>
                    <ul style="list-style-type: disc; margin-left: 20px;">
                        <li><strong>æƒ…å†µ A</strong>ï¼šæ‚¨æƒ³å®‰è£…ä¸€ä¸ªæ’ä»¶ï¼Œä½†ç‚¹å‡»å®‰è£…åï¼Œè¿›åº¦æ¡å¡åœ¨ 0% ä¸åŠ¨ï¼Œæˆ–è€…æç¤ºä¸‹è½½å¤±è´¥ã€‚è¿™æ˜¯å› ä¸º OpenWrt è¿ä¸ä¸Šå›½å¤–çš„è½¯ä»¶æºã€‚</li>
                        <li><strong>æƒ…å†µ B</strong>ï¼šç³»ç»Ÿæ›´æ–°ä¸‹è½½é€Ÿåº¦åªæœ‰å‡  KB/sï¼Œå‡çº§ä¸€ä¸ªè½¯ä»¶è¦åŠå°æ—¶ã€‚</li>
                    </ul>
                    <p><strong>ä½¿ç”¨æœ¬æ’ä»¶å</strong>ï¼šåªè¦æ‚¨çš„ç”µè„‘èƒ½ç§‘å­¦ä¸Šç½‘ï¼ŒOpenWrt å°±èƒ½é€šè¿‡æ‚¨çš„ç”µè„‘é«˜é€Ÿä¸‹è½½ï¼Œå‡ ç§’é’Ÿæå®šå‡çº§ï¼</p>
                </div>

                <h4 style="margin-bottom: 10px;">ğŸ“– ä½¿ç”¨æ•™ç¨‹</h4>
                <p><strong>1. ç”µè„‘ç«¯å‡†å¤‡ï¼š</strong><br/>
                æ‰“å¼€æ‚¨çš„ä»£ç†è½¯ä»¶ï¼ˆå¦‚ V2RayN, Clashï¼‰ï¼Œæ‰¾åˆ° <strong>"å…è®¸å±€åŸŸç½‘è¿æ¥" (Allow LAN)</strong> çš„å¼€å…³å¹¶å¼€å¯ã€‚</p>
                
                <p><strong>2. æ’ä»¶é…ç½®ï¼š</strong><br/>
                - <strong>å¯ç”¨ä»£ç†</strong>ï¼šé€‰æ‹© "å¯ç”¨"ã€‚<br/>
                - <strong>ä»£ç†æœåŠ¡å™¨IP</strong>ï¼šç‚¹å¼€ä¸‹æ‹‰æ¡†ï¼Œé€‰æ‹©æ‚¨ç”µè„‘çš„ IPï¼ˆé€šå¸¸æ˜¯ 192.168.x.x æˆ– 10.10.x.xï¼‰ã€‚<br/>
                - <strong>ä»£ç†ç«¯å£</strong>ï¼šå¡«å†™ä»£ç†è½¯ä»¶çš„å±€åŸŸç½‘ç«¯å£ï¼ˆV2RayN é»˜è®¤ 10808ï¼ŒClash é»˜è®¤ 7890ï¼‰ã€‚<br/>
                - <strong>ä»£ç†ç±»å‹</strong>ï¼šæ¨èé€‰æ‹© SOCKS5ã€‚</p>
                
                <p><strong>3. å¼€å§‹ä½¿ç”¨ï¼š</strong><br/>
                ç‚¹å‡» <strong>"æµ‹è¯•è¿æ¥"</strong>ï¼Œçœ‹åˆ°ç»¿è‰²çš„ "æˆåŠŸ" åï¼Œç‚¹å‡» <strong>"ä¿å­˜å¹¶åº”ç”¨"</strong>ï¼Œæœ€åç‚¹å‡» <strong>"å¼€å§‹å‡çº§"</strong>ã€‚</p>
                
                <div style="margin-top: 15px; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404;">
                <strong>âš ï¸ å¸¸è§é—®é¢˜ï¼š</strong><br/>
                å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œé€šå¸¸æ˜¯å› ä¸ºç”µè„‘é˜²ç«å¢™æ‹¦æˆªäº†ï¼Œæˆ–è€…ä»£ç†è½¯ä»¶æ²¡å¼€å¯"å…è®¸å±€åŸŸç½‘"ã€‚è¯·å°è¯•æš‚æ—¶å…³é—­ç”µè„‘é˜²ç«å¢™ã€‚
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
	function getValueBySuffix(suffix) {
		var elements = document.querySelectorAll('[id$="' + suffix + '"]');
		for (var i = 0; i < elements.length; i++) {
			var el = elements[i];
			if (el.value && el.value.trim() !== "") {
				return el.value;
			}
		}
		elements = document.querySelectorAll('[name$="' + suffix + '"]');
		for (var i = 0; i < elements.length; i++) {
			var el = elements[i];
			if (el.value && el.value.trim() !== "") {
				return el.value;
			}
		}
		return "";
	}

	function testProxy() {
		var resultSpan = document.getElementById('test-result');
		if (!resultSpan) return;
		
		try {
			resultSpan.innerHTML = "å‡†å¤‡æµ‹è¯•...";
			resultSpan.style.color = "black";
			
			var ip = getValueBySuffix("proxy_ip");
			var port = getValueBySuffix("proxy_port");
			var type = getValueBySuffix("proxy_type") || "http";
			var timeout = getValueBySuffix("timeout") || "5";
			
			console.log("Found: IP=" + ip + ", Port=" + port + ", Type=" + type + ", Timeout=" + timeout);
			
			if(!ip || !port) {
				resultSpan.innerHTML = "é”™è¯¯: æ— æ³•è·å–IPæˆ–ç«¯å£ (IP='" + ip + "', Port='" + port + "')";
				resultSpan.style.color = "red";
				return;
			}
			
			var btn = document.querySelector('input[value="æµ‹è¯•è¿æ¥"]');
			var originalVal = btn.value;
			btn.value = "æµ‹è¯•ä¸­...";
			btn.disabled = true;
			resultSpan.innerHTML = "æ­£åœ¨è¿æ¥ " + ip + ":" + port + " (" + type + ")...";
			
			var ts = new Date().getTime();
			
			XHR.get('<%=luci.dispatcher.build_url("admin", "system", "proxy-upgrade", "test")%>', 
				{ip: ip, port: port, type: type, timeout: timeout, _: ts}, 
				function(x, data) {
					btn.value = originalVal;
					btn.disabled = false;
					
					if (x.status == 200) {
						resultSpan.innerHTML = x.responseText;
						if (x.responseText && x.responseText.indexOf("æˆåŠŸ") !== -1) {
							resultSpan.style.color = "green";
						} else {
							resultSpan.style.color = "red";
						}
					} else {
						resultSpan.innerHTML = "è¯·æ±‚é”™è¯¯: " + x.status;
						resultSpan.style.color = "red";
					}
				}
			);
		} catch (e) {
			resultSpan.innerHTML = "JSé”™è¯¯: " + e.message;
			resultSpan.style.color = "red";
		}
	}
	
	function startUpgrade() {
		if(!confirm("ç¡®å®šè¦å¼€å§‹å‡çº§å—ï¼Ÿè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚")) return;
		
		document.getElementById('upgrade-log').value = "æ­£åœ¨å¯åŠ¨å‡çº§...\n";
		var btn = document.querySelector('input[value="å¼€å§‹å‡çº§"]');
		btn.disabled = true;
		
		XHR.get('<%=luci.dispatcher.build_url("admin", "system", "proxy-upgrade", "run")%>', null, function(x, data) {
			pollLog();
		});
	}
	
	function pollLog() {
		XHR.poll(2, '<%=luci.dispatcher.build_url("admin", "system", "proxy-upgrade", "log")%>', null, function(x, data) {
			var log = document.getElementById('upgrade-log');
			if(log) {
				log.value = x.responseText;
				log.scrollTop = log.scrollHeight;
			}
		});
	}
</script>
