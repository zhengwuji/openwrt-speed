name: Build OpenWrt Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare OpenWrt SDK
        run: |
          # Install aria2 for faster downloading
          sudo apt-get update
          sudo apt-get install -y aria2 build-essential ccache ecj fastjar file g++ gawk \
            gettext git libelf-dev libncurses5-dev \
            libncursesw5-dev libssl-dev python3 python3-setuptools \
            rsync subversion swig time xsltproc zlib1g-dev

          # Download OpenWrt SDK (x86/64 23.05.5) using aria2
          # Using 16 connections for maximum speed
          aria2c -x 16 -s 16 -o sdk.tar.xz https://downloads.openwrt.org/releases/23.05.5/targets/x86/64/openwrt-sdk-23.05.5-x86-64_gcc-12.3.0_musl.Linux-x86_64.tar.xz
          
          tar -xf sdk.tar.xz
          mv openwrt-sdk-* sdk

      - name: Prepare Package
        run: |
          # Copy our package to SDK
          mkdir -p sdk/package/luci-app-proxy-upgrade
          cp -r luci-app-proxy-upgrade/* sdk/package/luci-app-proxy-upgrade/
          
          # Update feeds
          cd sdk
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Compile Package
        working-directory: sdk
        run: |
          # Compile with verbose output for debugging
          make defconfig
          make package/luci-app-proxy-upgrade/compile V=s

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: luci-app-proxy-upgrade
          path: sdk/bin/packages/*/base/*.ipk

      - name: Upload Build Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            sdk/logs/
            sdk/tmp/
            sdk/.config
          retention-days: 5

      - name: Analyze Build Errors
        if: failure()
        run: |
          echo "## ðŸ”´ æž„å»ºå¤±è´¥ - é”™è¯¯åˆ†æž" > error_summary.md
          echo "" >> error_summary.md
          echo "**æž„å»ºç¼–å·**: #${{ github.run_number }}" >> error_summary.md
          echo "**å¤±è´¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> error_summary.md
          echo "**æäº¤å“ˆå¸Œ**: $(git log -1 --pretty=%h)" >> error_summary.md
          echo "" >> error_summary.md
          
          # æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ä¸­çš„é”™è¯¯
          if [ -d "sdk/logs" ]; then
            echo "### ðŸ“‹ ç¼–è¯‘é”™è¯¯è¯¦æƒ…" >> error_summary.md
            echo "" >> error_summary.md
            
            # æå–é”™è¯¯ä¿¡æ¯
            find sdk/logs -name "*.log" -type f | while read logfile; do
              if grep -q "error:" "$logfile" || grep -q "Error" "$logfile"; then
                echo "#### $(basename $logfile)" >> error_summary.md
                echo '```' >> error_summary.md
                grep -i "error" "$logfile" | head -20 >> error_summary.md
                echo '```' >> error_summary.md
                echo "" >> error_summary.md
              fi
            done
          fi
          
          # æ£€æŸ¥makeè¾“å‡ºä¸­çš„é”™è¯¯
          echo "### ðŸ” å¸¸è§é”™è¯¯ç±»åž‹" >> error_summary.md
          echo "" >> error_summary.md
          
          # æ£€æŸ¥ä¾èµ–é—®é¢˜
          if find sdk/logs -name "*.log" -exec grep -l "dependency" {} \; | head -1; then
            echo "- âŒ **ä¾èµ–é—®é¢˜**: ç¼ºå°‘å¿…è¦çš„ä¾èµ–åŒ…" >> error_summary.md
          fi
          
          # æ£€æŸ¥ç¼–è¯‘é”™è¯¯
          if find sdk/logs -name "*.log" -exec grep -l "compilation terminated" {} \; | head -1; then
            echo "- âŒ **ç¼–è¯‘é”™è¯¯**: ä»£ç ç¼–è¯‘å¤±è´¥" >> error_summary.md
          fi
          
          # æ£€æŸ¥é“¾æŽ¥é”™è¯¯
          if find sdk/logs -name "*.log" -exec grep -l "undefined reference" {} \; | head -1; then
            echo "- âŒ **é“¾æŽ¥é”™è¯¯**: ç¬¦å·æœªå®šä¹‰" >> error_summary.md
          fi
          
          echo "" >> error_summary.md
          echo "### ðŸ“ å®Œæ•´æ—¥å¿—" >> error_summary.md
          echo "å®Œæ•´çš„æž„å»ºæ—¥å¿—å·²ä¸Šä¼ åˆ° Artifactsï¼Œè¯·ä¸‹è½½ \`build-logs\` æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚" >> error_summary.md
          
          # æ˜¾ç¤ºé”™è¯¯æ‘˜è¦
          cat error_summary.md
          
          # ä¿å­˜åˆ°GitHub Step Summary
          cat error_summary.md >> $GITHUB_STEP_SUMMARY

      - name: Upload Error Summary
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-summary
          path: error_summary.md
          retention-days: 30

      - name: Generate Release Notes
        id: release_notes
        run: |
          # èŽ·å–æœ€æ–°çš„æäº¤ä¿¡æ¯
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_HASH=$(git log -1 --pretty=%h)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_DATE=$(git log -1 --pretty=%ad --date=format:'%Y-%m-%d %H:%M:%S')
          
          # ç”ŸæˆRelease Notes
          cat > release_notes.md << 'EOF'
          ## ðŸ“¦ luci-app-proxy-upgrade v1.0-${{ github.run_number }}
          
          ### ðŸ“ æ›´æ–°å†…å®¹
          
          **æäº¤ä¿¡æ¯**: ${COMMIT_MSG}
          
          **æäº¤å“ˆå¸Œ**: ${COMMIT_HASH}  
          **æäº¤ä½œè€…**: ${COMMIT_AUTHOR}  
          **æäº¤æ—¶é—´**: ${COMMIT_DATE}
          
          ### âœ¨ åŠŸèƒ½ç‰¹ç‚¹
          - ðŸŽ¨ å¯è§†åŒ–ç•Œé¢é…ç½®ä»£ç†è®¾ç½®
          - ðŸ” æ™ºèƒ½å‘çŽ°å±€åŸŸç½‘è®¾å¤‡
          - ðŸŒ‰ å®Œç¾Žæ”¯æŒæ¡¥æŽ¥æ¨¡å¼è·¯ç”±å™¨
          - ðŸ”„ æ­£ç¡®å¤„ç†å¤šIPè®¾å¤‡
          - âš¡ ä¸€é”®æµ‹è¯•ä»£ç†è¿žæŽ¥
          - ðŸŒ å…¨å±€ä»£ç†æ”¯æŒ
          - ðŸ“œ å®žæ—¶å‡çº§æ—¥å¿—æ˜¾ç¤º
          
          ### ðŸ“¥ å®‰è£…æ–¹æ³•
          ```bash
          # ä¸‹è½½IPKæ–‡ä»¶åˆ°OpenWrt
          wget https://github.com/zhengwuji/openwrt-speed/releases/download/v1.0-${{ github.run_number }}/luci-app-proxy-upgrade_1.0-1_all.ipk
          
          # å®‰è£…
          opkg update
          opkg install luci-app-proxy-upgrade_1.0-1_all.ipk
          ```
          
          ### ðŸ”§ ä½¿ç”¨è¯´æ˜Ž
          1. ç™»å½•OpenWrtç®¡ç†åŽå°
          2. è¿›å…¥ **ç³»ç»Ÿ** â†’ **ä»£ç†å‡çº§**
          3. å¯ç”¨ä»£ç†å¹¶é€‰æ‹©å±€åŸŸç½‘å†…çš„ä»£ç†æœåŠ¡å™¨
          4. æµ‹è¯•è¿žæŽ¥åŽä¿å­˜å¹¶å¼€å§‹å‡çº§
          
          ### ðŸ“š è¯¦ç»†æ–‡æ¡£
          è¯·æŸ¥çœ‹ [README.md](https://github.com/zhengwuji/openwrt-speed/blob/main/README.md)
          
          ---
          **æž„å»ºç¼–å·**: #${{ github.run_number }}  
          **æž„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main' && success()
        with:
          tag_name: v1.0-${{ github.run_number }}
          name: Release v1.0-${{ github.run_number }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          draft: false
          prerelease: false
          files: sdk/bin/packages/*/base/*.ipk
